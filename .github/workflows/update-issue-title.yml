name: Update Issue Title

on:
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to target"
        required: true
      dry_run:
        description: "Dry run mode"
        required: false
        default: "true"

jobs:
  update-title:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const isDispatch = context.eventName === 'workflow_dispatch';

            const issueNumber = isDispatch
              ? Number(context.payload.inputs.issue_number)
              : context.payload.issue.number;

            if (!issueNumber || Number.isNaN(issueNumber)) {
              throw new Error("Invalid issue number");
            }

            const dryRun = isDispatch && context.payload.inputs.dry_run === 'true';

            const { data: issue } = isDispatch
              ? await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                })
              : { data: context.payload.issue };

            const body = issue.body || "";
            const title = issue.title || "";
            const labels = issue.labels.map(l => typeof l === 'string' ? l : l.name);

            const PREFIX_MAP = {
              bug: "fix",
              feature: "feat",
              documentation: "docs",
              "ci/cd": "ci",
              test: "test",
              perf: "perf",
              refactor: "refactor",
              style: "style",
              chore: "chore",
            };

            const prefix =
              labels.find(l => PREFIX_MAP[l]) ?
              PREFIX_MAP[labels.find(l => PREFIX_MAP[l])] :
              "chore";

            const extract = (regex) => {
              const m = body.match(regex);
              return m ? m[1].trim() : "";
            };

            const contextValue = extract(/### Context\s*([\s\S]*?)(?=###|$)/);
            const summaryValue = extract(/### Summary\s*([\s\S]*?)(?=###|$)/);

            if (!contextValue || !summaryValue) {
              return;
            }

            const newTitle = `${prefix}(${contextValue}): ${summaryValue}`;

            if (newTitle === title) {
              return;
            }

            if (dryRun) {
              console.log(`[DRY_RUN] issue #${issueNumber}`);
              console.log(`[DRY_RUN] new title: ${newTitle}`);
              return;
            }

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              title: newTitle,
            });

            if (!labels.includes(contextValue)) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: [contextValue],
              });
            }

