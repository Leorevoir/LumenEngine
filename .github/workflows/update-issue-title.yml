name: Update Issue Title

on:
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to test'
        required: true
      dry_run:
        description: 'Dry run mode'
        required: false
        default: 'true'

jobs:
  update-title:
    runs-on: ubuntu-latest

    permissions:
      issues: write

    steps:
      - name: Update Issue Title
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const isWorkflowDispatch = context.eventName === 'workflow_dispatch';
            const dryRun = isWorkflowDispatch ? context.payload.inputs.dry_run === 'true' : false;
            
            let issueNumber;
            if (isWorkflowDispatch) {
              issueNumber = parseInt(context.payload.inputs.issue_number);
            } else {
              issueNumber = context.payload.issue.number;
            }
            
            let issue;
            if (isWorkflowDispatch) {
              const { data } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
              });
              issue = data;
            } else {
              issue = context.payload.issue;
            }

            const body = issue.body || "";
            const title = issue.title || "";
            const labels = issue.labels.map(l => typeof l === 'string' ? l : l.name);

            const LABEL_PREFIX_MAP = {
              bug: "fix",
              feature: "feat",
              documentation: "docs",
              "ci/cd": "ci",
              test: "test",
              perf: "perf",
              refactor: "refactor",
              style: "style",
              chore: "chore",
            };

            function getPrefix(labels) {
              const foundLabel = labels.find((label) => LABEL_PREFIX_MAP[label]);
              return foundLabel ? LABEL_PREFIX_MAP[foundLabel] : "chore";
            }

            function extractFromBody(regex, body) {
              const match = body.match(regex);
              return match ? match[1].trim() : "";
            }

            const contextValue = extractFromBody(/### Context\s*([\s\S]*?)(?=###|$)/, body);
            const summaryValue = extractFromBody(/### Summary\s*([\s\S]*?)(?=###|$)/, body);

            if (!contextValue || !summaryValue) {
              console.log("Missing context or summary. Skipping title update.");
              return;
            }

            const prefix = getPrefix(labels);
            const newTitle = `${prefix}(${contextValue}): ${summaryValue}`;

            if (newTitle === title) {
              console.log("Title already matches. No update needed.");
              return;
            }

            if (dryRun) {
              console.log(`[DRY_RUN] Would update issue #${issueNumber} title to: "${newTitle}"`);
              console.log(`[DRY_RUN] Would add label: "${contextValue}"`);
              return;
            }

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              title: newTitle,
            });

            if (!labels.includes(contextValue)) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: [contextValue],
              });
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: "Issue title has been automatically updated based on the provided context and summary.",
            });